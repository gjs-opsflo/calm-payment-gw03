name: DevSecOps Compliance CI Pipeline
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Linter and Type Checker # Quality Gate
        run: |
          echo "Running code quality checks..."
          # Example: npm run lint
  unit-test:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v3
      - name: Run Unit Tests
        run: |
          echo "Running unit tests..."
          # Example: npm test
  sast:
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - uses: actions/checkout@v3
      - name: Run Semgrep SAST # PCI-DSS: Detect insecure code patterns (SQLi, XSS, insecure crypto)
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          output-format: sarif
          audit-on-failure: true
  secret-detection:
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - uses: actions/checkout@v3
      - name: Run Gitleaks Secret Detection # PCI-DSS: Prevent credential leakage
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  sca:
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - uses: actions/checkout@v3
      - name: Run Trivy SCA # PCI-DSS: Identify vulnerable dependencies (for service nodes)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0' # Allow pipeline to continue for reporting
  sbom:
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - uses: actions/checkout@v3
      - name: Generate SBOM with Syft # NIST-CSF: Supply chain transparency for audit
        uses: anchore/syft-action@v0.5.0
        with:
          output: 'cyclonedx-json'
          file: 'sbom.json'
  build:
    runs-on: ubuntu-latest
    needs: [sast, secret-detection, sca, sbom] # All security scans must pass
    steps:
      - uses: actions/checkout@v3
      - name: Build Application Artifact # Final build artifact if all gates pass
        run: |
          echo "Building application artifact..."
          # Example: npm run build
